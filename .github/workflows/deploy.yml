name: ðŸš€ Deploy to AWS EC2

on:
  push:
    branches: [ main ]    # Only deploy from main branch
  workflow_dispatch:      # Allow manual deployment

jobs:
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸŽ¨ Check code formatting
        run: npm run format:check
        
      - name: ðŸ” Lint code
        run: npm run lint
        
      - name: ðŸ“ Type check
        run: npm run type-check
        
      - name: ðŸ—ï¸ Build applications
        run: npm run build
        
      - name: ðŸ§ª Run tests (if available)
        run: npm test --if-present
        
      - name: ðŸ”’ Security audit
        run: npm audit --audit-level=moderate
        
      - name: ðŸ”‘ Setup SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
          
      - name: ðŸ“¤ Deploy to EC2
        run: |
          # Add EC2 to known hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          
          # Configure SSH to prevent timeouts
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host deployment-server
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            ServerAliveInterval 60
            ServerAliveCountMax 3
            TCPKeepAlive yes
            ConnectTimeout 10
          EOF
          
          # Create deployment directory if it doesn't exist
          ssh deployment-server "
            mkdir -p /home/ubuntu/TaskTrek
            mkdir -p /home/ubuntu/backup
          "
          
          # Clone or update repository on EC2
          ssh deployment-server "
            if [ ! -d '/home/ubuntu/TaskTrek/.git' ]; then
              echo 'ðŸ“¥ Cloning repository...'
              git clone https://github.com/${{ github.repository }}.git /home/ubuntu/TaskTrek
            else
              echo 'ðŸ“¥ Repository already exists, updating...'
            fi
          "
          
          # Copy deployment script to EC2
          scp -o ConnectTimeout=10 -o ServerAliveInterval=60 scripts/deploy.sh deployment-server:/home/ubuntu/TaskTrek/
          scp -o ConnectTimeout=10 -o ServerAliveInterval=60 scripts/health-check.sh deployment-server:/home/ubuntu/TaskTrek/
          
          # Run deployment script with timeout protection
          ssh -o ConnectTimeout=10 -o ServerAliveInterval=60 deployment-server "
            cd /home/ubuntu/TaskTrek
            chmod +x deploy.sh health-check.sh
            timeout 900 ./deploy.sh || {
              echo 'Deployment script timed out after 15 minutes'
              exit 1
            }
          "
          
      - name: ðŸ” Health check
        run: |
          # Wait for services to start
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Run health check
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            cd /home/ubuntu/TaskTrek
            ./health-check.sh
          "
          
      - name: ðŸ“Š Deployment summary
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
          echo "ðŸ“… Deployed at: $(date)"
          echo "ðŸ”— Commit: ${{ github.sha }}"
          
      - name: ðŸ“§ Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ðŸ”— Check the logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
