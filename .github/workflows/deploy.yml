name: ğŸš€ Deploy to AWS EC2

on:
  push:
    branches: [ main ]    # Only deploy from main branch
  workflow_dispatch:      # Allow manual deployment

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ¨ Check code formatting
        run: npm run format:check
        
      - name: ğŸ” Lint code
        run: npm run lint
        
      - name: ğŸ“ Type check
        run: npm run type-check
        
      - name: ğŸ—ï¸ Build applications
        run: npm run build
        
      - name: ğŸ§ª Run tests (if available)
        run: npm test --if-present
        
      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=moderate
        
      - name: ğŸ”‘ Setup SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
          
      - name: ğŸ“¤ Deploy to EC2
        run: |
          # Add EC2 to known hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          
          # Create deployment directory if it doesn't exist
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            mkdir -p /home/ubuntu/TaskTrek
            mkdir -p /home/ubuntu/backup
          "
          
          # Clone or update repository on EC2
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            if [ ! -d '/home/ubuntu/TaskTrek/.git' ]; then
              echo 'ğŸ“¥ Cloning repository...'
              git clone https://github.com/${{ github.repository }}.git /home/ubuntu/TaskTrek
            else
              echo 'ğŸ“¥ Repository already exists, updating...'
            fi
          "
          
          # Copy deployment script to EC2
          scp scripts/deploy.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ubuntu/TaskTrek/
          scp scripts/health-check.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ubuntu/TaskTrek/
          
          # Run deployment script
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            cd /home/ubuntu/TaskTrek
            chmod +x deploy.sh health-check.sh
            ./deploy.sh
          "
          
      - name: ğŸ” Health check
        run: |
          # Wait for services to start
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Run health check
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            cd /home/ubuntu/TaskTrek
            ./health-check.sh
          "
          
      - name: ğŸ“Š Deployment summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          
      - name: ğŸ“§ Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ”— Check the logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
