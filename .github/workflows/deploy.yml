name: ðŸš€ Deploy to AWS EC2

on:
  push:
    branches: [ main ]    # Only deploy from main branch
  workflow_dispatch:      # Allow manual deployment

jobs:
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸŽ¨ Check code formatting
        run: npm run format:check
        
      - name: ðŸ” Lint code
        run: npm run lint
        
      - name: ðŸ“ Type check
        run: npm run type-check
        
      - name: ðŸ—ï¸ Build applications
        run: npm run build
        
      - name: ðŸ§ª Run tests (if available)
        run: npm test --if-present
        
      - name: ðŸ”’ Security audit
        run: npm audit --audit-level=moderate
        
      - name: ðŸ”‘ Setup SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
          
      - name: ï¿½ Create deployment package
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          
          # Create deployment directory
          mkdir -p deployment-package
          
          # Copy built applications
          cp -r apps/api/dist deployment-package/api-dist
          cp -r apps/web/.next deployment-package/web-next
          
          # Copy public directory if it exists, otherwise create empty one
          if [ -d "apps/web/public" ]; then
            cp -r apps/web/public deployment-package/web-public
          else
            mkdir -p deployment-package/web-public
            echo "âš ï¸ No public directory found, created empty one"
          fi
          
          # Copy essential files
          cp ecosystem.config.js deployment-package/
          cp package.json deployment-package/
          cp apps/api/package.json deployment-package/api-package.json
          cp apps/web/package.json deployment-package/web-package.json
          
          # Copy scripts
          cp scripts/health-check.sh deployment-package/
          
          # Create production package.json with only production dependencies
          node -e "
            const pkg = require('./package.json');
            const prodPkg = {
              name: pkg.name,
              version: pkg.version,
              scripts: {
                start: 'pm2 start ecosystem.config.js'
              },
              dependencies: {}
            };
            require('fs').writeFileSync('./deployment-package/package.json', JSON.stringify(prodPkg, null, 2));
          "
          
          # Create optimized deploy script for production
          cat > deployment-package/deploy-production.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ðŸš€ Starting production deployment..."
          
          # Stop applications
          echo "ðŸ›‘ Stopping applications..."
          pm2 stop tasktrek-api tasktrek-web || echo "âš ï¸ No running processes"
          
          # Create logs directory
          mkdir -p logs
          
          # Copy built files to correct locations
          echo "ðŸ“ Setting up application structure..."
          mkdir -p apps/api/dist apps/web/.next apps/web/public
          
          cp -r api-dist/* apps/api/dist/
          cp -r web-next/* apps/web/.next/
          
          # Copy public files if they exist
          if [ -d "web-public" ] && [ "$(ls -A web-public 2>/dev/null)" ]; then
            cp -r web-public/* apps/web/public/
            echo "âœ… Copied public files"
          else
            echo "âš ï¸ No public files to copy"
          fi
          
          # Copy package.json files for dependencies
          cp api-package.json apps/api/package.json
          cp web-package.json apps/web/package.json
          
          # Install only runtime dependencies for API
          echo "ðŸ“¦ Installing API runtime dependencies..."
          cd apps/api
          npm ci --production --prefer-offline --no-audit --no-fund || echo "âš ï¸ API deps install failed"
          cd ../..
          
          # Start applications
          echo "ðŸš€ Starting applications with PM2..."
          pm2 delete tasktrek-api tasktrek-web || echo "âš ï¸ No processes to delete"
          pm2 start ecosystem.config.js
          pm2 save
          
          echo "âœ… Production deployment completed!"
          EOF
          
          chmod +x deployment-package/deploy-production.sh
          
          # List contents for debugging
          echo "ðŸ“‹ Deployment package contents:"
          ls -la deployment-package/
          
          # Create archive
          tar -czf deployment.tar.gz -C deployment-package .
          
          # Show archive size
          echo "ðŸ“¦ Deployment package size: $(du -h deployment.tar.gz | cut -f1)"
          echo "âœ… Deployment package created"
      - name: ðŸ“¤ Deploy to EC2
        run: |
          # Add EC2 to known hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          
          # Configure SSH to prevent timeouts
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host deployment-server
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            ServerAliveInterval 60
            ServerAliveCountMax 3
            TCPKeepAlive yes
            ConnectTimeout 10
          EOF
          
          # Create deployment directory
          ssh deployment-server "
            mkdir -p /home/ubuntu/TaskTrek
            mkdir -p /home/ubuntu/backup
          "
          
          # Create backup of current deployment
          ssh deployment-server "
            if [ -d '/home/ubuntu/TaskTrek' ]; then
              cp -r /home/ubuntu/TaskTrek /home/ubuntu/backup/tasktrek-backup-\$(date +%Y%m%d-%H%M%S) || echo 'Backup failed'
            fi
          "
          
          # Upload deployment package
          echo "ðŸ“¤ Uploading deployment package..."
          scp -o ConnectTimeout=10 -o ServerAliveInterval=60 deployment.tar.gz deployment-server:/home/ubuntu/TaskTrek/
          
          # Extract and deploy
          ssh -o ConnectTimeout=10 -o ServerAliveInterval=60 deployment-server "
            cd /home/ubuntu/TaskTrek
            
            # Extract deployment package
            echo 'ðŸ“¦ Extracting deployment package...'
            tar -xzf deployment.tar.gz
            
            # Make deploy script executable and run it
            chmod +x deploy-production.sh
            ./deploy-production.sh
            
            # Clean up
            rm -f deployment.tar.gz
          "
          
      - name: ðŸ” Health check
        run: |
          # Wait for services to start
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Run health check using the same SSH configuration
          ssh -o ConnectTimeout=10 -o ServerAliveInterval=60 deployment-server "
            cd /home/ubuntu/TaskTrek
            ./health-check.sh
          "
          
      - name: ðŸ“Š Deployment summary
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
          echo "ðŸ“… Deployed at: $(date)"
          echo "ðŸ”— Commit: ${{ github.sha }}"
          
      - name: ðŸ“§ Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ðŸ”— Check the logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
